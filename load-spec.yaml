functions:
- type: subflow
  id: key
  workflow: "/uri-tag-key"
- type: knative-workflow
  id: yaml
  image: localhost:5000/yaml2json
states:
- id: a
  type: action
  log: 'jq(.)'
  action:
    function: key
    input: 'jq(.)'
  transform: 'jq(.args = .return | del(.return))'
  transition: b
- id: b
  type: getter
  log: 'jq(.)'
  variables:
    - scope: namespace
      key: 'jq(("spec_" + .args.key))'
      as: x
  transition: c
- id: c
  type: noop
  log: 'jq(.)'
  transform: 'jq(del(.args) | .swagger = .var.x | del(.var))'
  transition: d
- id: d
  type: setter
  log: 'jq(.)'
  variables:
    - scope: instance
      key: spec
      mimeType: application/octet-stream
      value: 'jq(.swagger | @base64)'
  transition: e
- id: e
  type: action 
  log: 'jq(.)'
  action:
    function: yaml 
    files:
      - key: spec
        scope: instance
    input:
      data: spec
      output-format: json 
      input-type: file
  transition: f
- id: f
  type: noop
  log: 'jq(.)'
  transform: 'jq(.spec = .return.output.result | del(.return, .swagger, .uri))'

