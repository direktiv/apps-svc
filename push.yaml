functions:
- type: subflow
  id: key
  workflow: '/uri-tag-key'
- id: document
  image: localhost:5000/document
  type: knative-workflow
- id: pq
  type: subflow
  workflow: "/pq"
states:
- id: a
  type: action 
  log: 'jq(.)'
  action:
    function: key
    input: 'jq(.)'
  transform: 'jq(.args = .return | del(.return))'
  transition: b
- id: b
  type: noop 
  log: 'jq(.)'
  # action:
  #   funcion: document 
  #   input: 'jq(.data)'
  transition: c
- id: c
  type: setter
  log: 'jq(.)'
  variables:
  - scope: namespace
    key: 'jq(("spec_" + .args.key))'
    mimeType: 'text/plain'
    value: 'jq(.data | @base64d)'
  # - scope: namespace 
  #   key: 'jq(("md_" + .args.key))'
  #   mimeType: 'text/markdown'
  #   value: 'jq(.return)'
  transition: d
- id: d
  type: action 
  log: 'jq(.)'
  action:
    function: pq 
    input:
      queries: 
        - "UPDATE apps SET created_at = now() WHERE uri = :'URI' AND tag = :'TAG'"
        - "INSERT INTO apps (uri, tag) VALUES (:'URI', :'TAG') ON CONFLICT (uri,tag) DO NOTHING"
      args:
        - 'jq("URI=" + .args.uri)'
        - 'jq("TAG=" + .args.tag)'
